name: Deploy to Server

on:
    workflow_run:
        workflows: ['CI']
        types:
            - completed
        branches:
            - main
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        # Only one deployment at a time
        concurrency:
            group: deploy
            cancel-in-progress: false
        # Only deploy if CI workflow succeeded
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.workflow_run.head_branch || github.ref }}

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Add server to known hosts
              run: |
                  ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true

            - name: Verify SSH key
              run: |
                  echo "Checking SSH agent..."
                  ssh-add -l || echo "No keys in agent"
                  echo "SSH_AUTH_SOCK: $SSH_AUTH_SOCK"

            - name: Deploy to server
              timeout-minutes: 15
              run: |
                  # Remove any default SSH keys to force using agent key only
                  rm -f ~/.ssh/id_* 2>/dev/null || true

                  # Configure SSH to use only agent key
                  ssh -v -o StrictHostKeyChecking=no \
                      -o IdentitiesOnly=yes \
                      -o PreferredAuthentications=publickey \
                      -o PubkeyAuthentication=yes \
                      -o PasswordAuthentication=no \
                      root@${{ secrets.SERVER_HOST }} '
                    set -e
                    
                    # Navigate to project directory
                    PROJECT_DIR="/var/www/first-calc"
                    mkdir -p $PROJECT_DIR
                    cd $PROJECT_DIR
                    
                    # Pull latest changes from GitHub
                    if [ -d ".git" ]; then
                      echo "Updating repository..."
                      git fetch origin
                      git reset --hard origin/main
                    else
                      echo "Cloning repository..."
                      git clone https://github.com/alex1c/first-calc.git .
                    fi
                    
                    # Stop existing container if running
                    echo "Stopping existing container..."
                    docker-compose down || true
                    
                    # Build and start new container
                    echo "Building new container..."
                    docker-compose build --no-cache
                    
                    echo "Starting container..."
                    docker-compose up -d
                    
                    # Clean up old images
                    echo "Cleaning up old Docker images..."
                    docker image prune -f
                    
                    # Wait for container to be ready
                    echo "Waiting for container to be ready..."
                    sleep 15
                    
                    # Check if container is running
                    if docker ps | grep -q first-calc; then
                      echo "✓ Deployment successful!"
                      echo "Container status:"
                      docker ps | grep first-calc
                      echo ""
                      echo "Container logs (last 20 lines):"
                      docker logs --tail 20 first-calc
                    else
                      echo "✗ Deployment failed - container is not running"
                      echo "Container logs:"
                      docker-compose logs
                      exit 1
                    fi
                  '
