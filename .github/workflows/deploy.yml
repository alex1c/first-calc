name: Deploy to Server

on:
    workflow_run:
        workflows: ['CI']
        types:
            - completed
        branches:
            - main
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        # Only deploy if CI workflow succeeded
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.workflow_run.head_branch || github.ref }}

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Add server to known hosts
              run: |
                  ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true

            - name: Deploy to server
              timeout-minutes: 15
              run: |
                  echo "Attempting SSH connection to ${{ secrets.SERVER_HOST }}..."

                  # Configure SSH to use only the provided key
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh

                  # Debug: Check if SSH agent has keys
                  echo "Checking SSH agent keys..."
                  ssh-add -l || echo "No keys in agent or agent not running"

                  # Remove default SSH keys to force using agent key only
                  rm -f ~/.ssh/id_rsa ~/.ssh/id_ecdsa ~/.ssh/id_ecdsa_sk ~/.ssh/id_ed25519 ~/.ssh/id_ed25519_sk ~/.ssh/id_xmss ~/.ssh/id_dsa 2>/dev/null || true

                  # Create SSH config to use only agent key
                  cat > ~/.ssh/config << 'SSHCONFIG'
                  Host *
                      IdentitiesOnly yes
                      PreferredAuthentications publickey
                      PubkeyAuthentication yes
                      PasswordAuthentication no
                      IdentityAgent $SSH_AUTH_SOCK
                  SSHCONFIG
                  chmod 600 ~/.ssh/config

                  # Try SSH connection
                  ssh -o ConnectTimeout=30 \
                      -o StrictHostKeyChecking=no \
                      -o ServerAliveInterval=60 \
                      -o ServerAliveCountMax=3 \
                      -o TCPKeepAlive=yes \
                      -o IdentitiesOnly=yes \
                      -o PreferredAuthentications=publickey \
                      -o PubkeyAuthentication=yes \
                      -o PasswordAuthentication=no \
                      -o IdentityAgent=$SSH_AUTH_SOCK \
                      root@${{ secrets.SERVER_HOST }} '
                    set -e
                    
                    # Navigate to project directory
                    PROJECT_DIR="/var/www/first-calc"
                    mkdir -p $PROJECT_DIR
                    cd $PROJECT_DIR
                    
                    # Pull latest changes from GitHub
                    if [ -d ".git" ]; then
                      echo "Updating repository..."
                      git fetch origin
                      git reset --hard origin/main
                    else
                      echo "Cloning repository..."
                      git clone https://github.com/alex1c/first-calc.git .
                    fi
                    
                    # Stop existing container if running
                    echo "Stopping existing container..."
                    docker-compose down || true
                    
                    # Build and start new container
                    echo "Building new container..."
                    docker-compose build --no-cache
                    
                    echo "Starting container..."
                    docker-compose up -d
                    
                    # Clean up old images
                    echo "Cleaning up old Docker images..."
                    docker image prune -f
                    
                    # Wait for container to be ready
                    echo "Waiting for container to be ready..."
                    sleep 15
                    
                    # Check if container is running
                    if docker ps | grep -q first-calc; then
                      echo "✓ Deployment successful!"
                      echo "Container status:"
                      docker ps | grep first-calc
                      echo ""
                      echo "Container logs (last 20 lines):"
                      docker logs --tail 20 first-calc
                    else
                      echo "✗ Deployment failed - container is not running"
                      echo "Container logs:"
                      docker-compose logs
                      exit 1
                    fi
                  '
