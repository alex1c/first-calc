name: Deploy to Server

on:
    workflow_run:
        workflows: ['CI']
        types:
            - completed
        branches:
            - main
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        # Only deploy if CI workflow succeeded
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.workflow_run.head_branch || github.ref }}

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Add server to known hosts
              run: |
                  ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

            - name: Wait for SSH connection
              run: |
                  echo "Waiting for SSH connection to be available..."
                  MAX_ATTEMPTS=10
                  RETRY_DELAY=10

                  for i in $(seq 1 $MAX_ATTEMPTS); do
                    echo "Attempt $i of $MAX_ATTEMPTS..."
                    if ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o BatchMode=yes root@${{ secrets.SERVER_HOST }} 'echo "SSH connection successful"' 2>/dev/null; then
                      echo "✓ SSH connection established"
                      exit 0
                    fi
                    if [ $i -lt $MAX_ATTEMPTS ]; then
                      echo "Connection failed, waiting ${RETRY_DELAY} seconds before retry..."
                      sleep $RETRY_DELAY
                    fi
                  done

                  echo "✗ Failed to establish SSH connection after $MAX_ATTEMPTS attempts"
                  echo "This might be due to:"
                  echo "  - Server firewall blocking connections"
                  echo "  - SSH service not running"
                  echo "  - Network issues"
                  exit 1

            - name: Deploy to server
              run: |
                  ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} '
                    set -e
                    
                    # Navigate to project directory
                    PROJECT_DIR="/var/www/first-calc"
                    mkdir -p $PROJECT_DIR
                    cd $PROJECT_DIR
                    
                    # Pull latest changes from GitHub
                    if [ -d ".git" ]; then
                      echo "Updating repository..."
                      git fetch origin
                      git reset --hard origin/main
                    else
                      echo "Cloning repository..."
                      git clone https://github.com/alex1c/first-calc.git .
                    fi
                    
                    # Stop existing container if running
                    echo "Stopping existing container..."
                    docker-compose down || true
                    
                    # Build and start new container
                    echo "Building new container..."
                    docker-compose build --no-cache
                    
                    echo "Starting container..."
                    docker-compose up -d
                    
                    # Clean up old images
                    echo "Cleaning up old Docker images..."
                    docker image prune -f
                    
                    # Wait for container to be ready
                    echo "Waiting for container to be ready..."
                    sleep 15
                    
                    # Check if container is running
                    if docker ps | grep -q first-calc; then
                      echo "✓ Deployment successful!"
                      echo "Container status:"
                      docker ps | grep first-calc
                      echo ""
                      echo "Container logs (last 20 lines):"
                      docker logs --tail 20 first-calc
                    else
                      echo "✗ Deployment failed - container is not running"
                      echo "Container logs:"
                      docker-compose logs
                      exit 1
                    fi
                  '
