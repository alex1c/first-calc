name: Deploy to Server

on:
	push:
		branches:
			- main
	workflow_dispatch:

jobs:
	deploy:
		runs-on: ubuntu-latest
		
		steps:
			- name: Checkout code
			  uses: actions/checkout@v4
			
			- name: Setup SSH
			  uses: webfactory/ssh-agent@v0.9.0
			  with:
				  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
			
			- name: Add server to known hosts
			  run: |
				  ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
			
			- name: Deploy to server
			  run: |
				  ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'ENDSSH'
				  set -e
				  
				  # Navigate to project directory
				  PROJECT_DIR="/opt/first-calc"
				  mkdir -p $PROJECT_DIR
				  cd $PROJECT_DIR
				  
				  # Pull latest changes from GitHub
				  if [ -d ".git" ]; then
					  echo "Updating repository..."
					  git fetch origin
					  git reset --hard origin/main
				  else
					  echo "Cloning repository..."
					  git clone https://github.com/alex1c/first-calc.git .
				  fi
				  
				  # Stop existing container if running
				  echo "Stopping existing container..."
				  docker-compose down || true
				  
				  # Build and start new container
				  echo "Building new container..."
				  docker-compose build --no-cache
				  
				  echo "Starting container..."
				  docker-compose up -d
				  
				  # Clean up old images
				  echo "Cleaning up old Docker images..."
				  docker image prune -f
				  
				  # Wait for container to be ready
				  echo "Waiting for container to be ready..."
				  sleep 15
				  
				  # Check if container is running
				  if docker ps | grep -q first-calc; then
					  echo "✓ Deployment successful!"
					  echo "Container status:"
					  docker ps | grep first-calc
					  echo ""
					  echo "Container logs (last 20 lines):"
					  docker logs --tail 20 first-calc
				  else
					  echo "✗ Deployment failed - container is not running"
					  echo "Container logs:"
					  docker-compose logs
					  exit 1
				  fi
				  ENDSSH

