name: Deploy to Server

on:
    workflow_run:
        workflows: ['CI']
        types:
            - completed
        branches:
            - main
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        # Only one deployment at a time
        concurrency:
            group: deploy
            cancel-in-progress: false
        # Only deploy if CI workflow succeeded
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.workflow_run.head_branch || github.ref }}

            - name: Setup SSH key
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh

                  # Check if secret is set
                  if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
                      echo "ERROR: SSH_PRIVATE_KEY secret is not set!"
                      echo "Please add SSH_PRIVATE_KEY secret in repository settings"
                      exit 1
                  fi

                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key

                  # Verify key format
                  echo "=== Key Format Check ==="
                  echo "First line:"
                  head -1 ~/.ssh/deploy_key
                  echo "Last line:"
                  tail -1 ~/.ssh/deploy_key
                  echo "Key length:"
                  wc -l ~/.ssh/deploy_key

                  # Get public key from private and check fingerprint
                  echo ""
                  echo "=== Extracting Public Key ==="
                  if ssh-keygen -y -f ~/.ssh/deploy_key > ~/.ssh/deploy_key.pub 2>&1; then
                      echo "Public key extracted successfully"
                      echo "Fingerprint:"
                      ssh-keygen -lf ~/.ssh/deploy_key.pub
                      echo ""
                      echo "Expected fingerprint: SHA256:PwnqD/gRXu7Jb1OlJLX5+BjwIg98ljLfROqcYl5BPTE"
                  else
                      echo "ERROR: Failed to extract public key from private key"
                      echo "This usually means the key format is incorrect"
                      exit 1
                  fi

            - name: Add server to known hosts
              run: |
                  ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts || true

            - name: Deploy to server
              timeout-minutes: 15
              run: |
                  ssh -i ~/.ssh/deploy_key \
                      -o StrictHostKeyChecking=no \
                      -o IdentitiesOnly=yes \
                      -o PreferredAuthentications=publickey \
                      root@${{ secrets.SERVER_HOST }} '
                    set -e
                    
                    # Navigate to project directory
                    PROJECT_DIR="/var/www/first-calc"
                    mkdir -p $PROJECT_DIR
                    cd $PROJECT_DIR
                    
                    # Pull latest changes from GitHub
                    if [ -d ".git" ]; then
                      echo "Updating repository..."
                      git fetch origin
                      git reset --hard origin/main
                    else
                      echo "Cloning repository..."
                      git clone https://github.com/alex1c/first-calc.git .
                    fi
                    
                    # Stop existing container if running
                    echo "Stopping existing container..."
                    docker-compose down || true
                    
                    # Build and start new container
                    echo "Building new container..."
                    docker-compose build --no-cache
                    
                    echo "Starting container..."
                    docker-compose up -d
                    
                    # Clean up old images
                    echo "Cleaning up old Docker images..."
                    docker image prune -f
                    
                    # Wait for container to be ready
                    echo "Waiting for container to be ready..."
                    sleep 15
                    
                    # Check if container is running
                    if docker ps | grep -q first-calc; then
                      echo "✓ Deployment successful!"
                      echo "Container status:"
                      docker ps | grep first-calc
                      echo ""
                      echo "Container logs (last 20 lines):"
                      docker logs --tail 20 first-calc
                    else
                      echo "✗ Deployment failed - container is not running"
                      echo "Container logs:"
                      docker-compose logs
                      exit 1
                    fi
                  '
